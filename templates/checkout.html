{% extends "layout.html" %}

{% block title %}Check-in{% endblock %}

{% block h1 %} Check-in <i class="fas fa-ticket me-2"></i>{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Escaneo de QR -->
  <div class="row">
    <div class="col-md-6 mb-5">
      <div class="card shadow-sm mb-4">
  <div class="card-header bg-success text-white">
    <h5 class="mb-0"> <i class="fas fa-qrcode me-2"></i> Escaneo de c√≥digo QR</h5>
  </div>
  <div class="card-body text-center">
    <div id="reader" style="width: 100%; max-width: 360px; height: 320px; margin: auto;"></div>
    <form method="POST" id="form-checkin">
      <input type="text" name="codigo_qr" id="codigo_qr_input" hidden required>
    </form>
  </div>
</div>

    </div>

    <!-- B√∫squeda manual -->
    <div class="col-md-6 mb-5">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fa-solid fa-magnifying-glass"></i> B√∫squeda manual</h5>
        </div>
        <div class="card-body">
          <form method="POST" class="d-flex gap-2">
            <input type="text" class="form-control" name="busqueda" placeholder="Nombre, correo o ticket ID" value="{{ query or '' }}" required>
            <button type="submit" class="btn btn-primary">Buscar</button>
          </form>

          {% if resultados %}
            <div class="table-responsive mt-4">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Ticket ID</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                  </tr>
                </thead>
                <tbody>
                  {% for asistente in resultados %}
                  <tr>
                    <td>{{ asistente.nombre }}</td>
                    <td>{{ asistente.correo }}</td>
                    <td>{{ asistente.ticket_id }}</td>
                    <td>{% if asistente.checked_in %}‚úÖ{% else %}‚ùå{% endif %}</td>
                    <td>
                      {% if not asistente.checked_in %}
                        <form method="POST" action="{{ url_for('routes.confirmar_checkin', id=asistente._id) }}">
                          <button type="submit" class="btn btn-sm btn-success">Check-in</button>
                        </form>
                      {% else %}
                        <span class="text-muted small">Registrado</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% elif query %}
            <p class="mt-3 text-muted">No se encontraron resultados para "{{ query }}"</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de resultado del QR -->
  <div class="modal fade" id="resultadoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">Resultado del Check-in</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          {% if asistente %}
            <p><strong>Nombre:</strong> {{ asistente.nombre }}</p>
            <p><strong>Correo:</strong> {{ asistente.correo }}</p>
            <p><strong>Ticket ID:</strong> {{ asistente.ticket_id }}</p>
            <p><strong>Estado:</strong>
              {% if asistente.checked_in %}
                ‚úÖ Ya registrado el {{ asistente.timestamp_checkin.strftime('%d/%m/%Y %H:%M:%S') if asistente.timestamp_checkin else 'anteriormente' }}
              {% else %}
                üü¢ Nuevo registro exitoso
              {% endif %}
            </p>
            {% if asistente.registrado_por %}
              <p><strong>Registrado por:</strong> {{ asistente.registrado_por }}</p>
            {% endif %}
          {% elif mensaje %}
            <p>{{ mensaje }}</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" onclick="cerrarModal()">OK</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Script para QR -->

<!-- Librer√≠a QR -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    
    if (typeof Html5Qrcode === 'undefined') {
      alert("Error: no se pudo cargar el lector QR.");
      return;
    }
    var myModal = new bootstrap.Modal(document.getElementById('resultadoModal'));
    myModal.show();
    const html5QrCode = new Html5Qrcode("reader");

    function onScanSuccess(decodedText) {
      html5QrCode.stop().then(() => {
        document.getElementById('codigo_qr_input').value = decodedText;
        document.getElementById('form-checkin').submit();
      });
    }

    Html5Qrcode.getCameras().then(devices => {
    const backCamera = devices.find(device => /back|environment/i.test(device.label)) || devices[0];

      if (devices.length) {
        html5QrCode.start(
          { deviceId: { exact: backCamera.id } },
          { fps: 10, qrbox: 250 },
          onScanSuccess
        ).catch(err => console.error("Error al iniciar esc√°ner:", err));
      } else {
        alert("No se detectaron c√°maras.");
      }
    }).catch(err => {
      alert("Error accediendo a la c√°mara.");
      console.error("Error obteniendo c√°maras:", err);
    });
  });
</script>


{% endblock %}
